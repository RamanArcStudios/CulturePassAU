<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CulturePass Dashboard</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--primary:#007AFF;--primary-light:#409CFF;--secondary:#5856D6;--accent:#FF9500;--bg:#F2F2F7;--surface:#FFF;--text:#000;--text2:#8E8E93;--text3:#AEAEB2;--border:#E5E5EA;--success:#34C759;--error:#FF3B30;--warning:#FF9F0A;--radius:12px;--shadow:0 1px 3px rgba(0,0,0,0.04),0 2px 8px rgba(0,0,0,0.08)}
body{font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display','Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);line-height:1.5;min-height:100vh}
a{color:var(--primary);text-decoration:none}

.sidebar{position:fixed;left:0;top:0;bottom:0;width:260px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;z-index:10}
.sidebar-logo{padding:24px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
.sidebar-logo svg{width:28px;height:28px;fill:var(--primary)}
.sidebar-logo h1{font-size:18px;font-weight:700;color:var(--text)}
.sidebar-logo span{font-size:10px;font-weight:600;color:var(--text2);background:var(--bg);padding:2px 6px;border-radius:4px;margin-left:4px}
.sidebar-nav{flex:1;padding:12px 10px;overflow-y:auto}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:var(--radius);cursor:pointer;font-size:14px;font-weight:500;color:var(--text2);transition:all 0.15s}
.nav-item:hover{background:var(--bg);color:var(--text)}
.nav-item.active{background:var(--primary);color:#FFF}
.nav-item svg{width:18px;height:18px;flex-shrink:0}
.nav-item.active svg{fill:#FFF}
.nav-section{font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;padding:16px 14px 6px}

.main{margin-left:260px;padding:24px 32px 40px}
.topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:28px}
.topbar h2{font-size:28px;font-weight:700;letter-spacing:-0.3px}
.topbar-actions{display:flex;gap:8px}
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:var(--radius);font-size:13px;font-weight:600;border:none;cursor:pointer;transition:all 0.15s}
.btn-primary{background:var(--primary);color:#FFF}
.btn-primary:hover{opacity:0.9}
.btn-outline{background:var(--surface);color:var(--text);border:1px solid var(--border)}
.btn-outline:hover{background:var(--bg)}
.btn-sm{padding:6px 12px;font-size:12px}
.btn-danger{background:var(--error);color:#FFF}
.btn-success{background:var(--success);color:#FFF}

.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:28px}
.stat-card{background:var(--surface);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow)}
.stat-card .label{font-size:12px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px}
.stat-card .value{font-size:28px;font-weight:700;margin-top:6px}
.stat-card .change{font-size:12px;font-weight:600;margin-top:4px}
.stat-card .change.up{color:var(--success)}
.stat-card .change.down{color:var(--error)}
.stat-card .icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;margin-bottom:10px}

.card{background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;margin-bottom:20px}
.card-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border)}
.card-header h3{font-size:16px;font-weight:700}
.card-body{padding:20px}
.card-body.no-pad{padding:0}

table{width:100%;border-collapse:collapse}
th{text-align:left;font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;padding:10px 16px;border-bottom:1px solid var(--border)}
td{padding:12px 16px;border-bottom:1px solid var(--border);font-size:13px}
tr:last-child td{border-bottom:none}
tr:hover td{background:rgba(0,0,0,0.01)}

.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:6px;font-size:11px;font-weight:600}
.badge-success{background:rgba(52,199,89,0.12);color:var(--success)}
.badge-warning{background:rgba(255,159,10,0.12);color:var(--warning)}
.badge-error{background:rgba(255,59,48,0.12);color:var(--error)}
.badge-info{background:rgba(0,122,255,0.12);color:var(--primary)}
.badge-neutral{background:var(--bg);color:var(--text2)}

.ticket-code{font-family:SFMono-Regular,Menlo,monospace;font-size:12px;font-weight:600;color:var(--primary);background:rgba(0,122,255,0.06);padding:2px 8px;border-radius:4px}

.grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:20px}

.avatar{width:32px;height:32px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;color:#FFF;font-size:12px;font-weight:700;flex-shrink:0}

.empty-state{text-align:center;padding:60px 20px;color:var(--text2)}
.empty-state svg{width:48px;height:48px;fill:var(--text3);margin-bottom:12px}
.empty-state h4{font-size:16px;font-weight:600;color:var(--text);margin-bottom:4px}
.empty-state p{font-size:13px}

.tab-nav{display:flex;gap:0;border-bottom:1px solid var(--border);padding:0 20px}
.tab-btn{padding:10px 16px;font-size:13px;font-weight:600;color:var(--text2);border:none;background:none;cursor:pointer;border-bottom:2px solid transparent;transition:all 0.15s}
.tab-btn.active{color:var(--primary);border-bottom-color:var(--primary)}
.tab-content{display:none}.tab-content.active{display:block}

.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:100;align-items:center;justify-content:center}
.modal-overlay.show{display:flex}
.modal{background:var(--surface);border-radius:16px;width:480px;max-width:90vw;max-height:85vh;overflow-y:auto;box-shadow:0 8px 32px rgba(0,0,0,0.2)}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:18px 20px;border-bottom:1px solid var(--border)}
.modal-header h3{font-size:17px;font-weight:700}
.modal-close{width:28px;height:28px;border-radius:14px;background:var(--bg);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;color:var(--text2)}
.modal-body{padding:20px}
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px}
.form-input{width:100%;padding:10px 14px;border:1px solid var(--border);border-radius:var(--radius);font-size:14px;font-family:inherit;outline:none;transition:border-color 0.15s}
.form-input:focus{border-color:var(--primary)}
.form-input::placeholder{color:var(--text3)}
select.form-input{appearance:none;background:url("data:image/svg+xml,%3Csvg width='10' height='6' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%238E8E93'/%3E%3C/svg%3E") no-repeat right 12px center var(--surface)}

.toast{position:fixed;bottom:24px;right:24px;background:var(--text);color:#FFF;padding:12px 20px;border-radius:var(--radius);font-size:13px;font-weight:600;z-index:200;transform:translateY(100px);opacity:0;transition:all 0.3s}
.toast.show{transform:translateY(0);opacity:1}

.chart-bar{display:flex;align-items:flex-end;gap:6px;height:120px;padding:0 4px}
.chart-bar .bar{flex:1;background:var(--primary);border-radius:4px 4px 0 0;min-height:4px;transition:height 0.5s;position:relative}
.chart-bar .bar:hover{opacity:0.8}
.chart-labels{display:flex;gap:6px;padding:6px 4px 0}
.chart-labels span{flex:1;text-align:center;font-size:10px;color:var(--text3);font-weight:500}

.search-input{padding:8px 14px 8px 36px;border:1px solid var(--border);border-radius:var(--radius);font-size:13px;width:240px;outline:none;background:var(--surface) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%238E8E93' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'/%3E%3C/svg%3E") no-repeat 12px center}
.search-input:focus{border-color:var(--primary)}

@media(max-width:768px){.sidebar{width:0;overflow:hidden}.main{margin-left:0}.stats-grid{grid-template-columns:repeat(2,1fr)}.grid-2{grid-template-columns:1fr}}

.login-page{display:flex;align-items:center;justify-content:center;min-height:100vh;background:var(--bg)}
.login-card{background:var(--surface);border-radius:16px;padding:40px;width:380px;max-width:90vw;box-shadow:var(--shadow);text-align:center}
.login-card h2{font-size:24px;font-weight:700;margin-bottom:4px}
.login-card p{font-size:14px;color:var(--text2);margin-bottom:24px}
.login-card .form-group{text-align:left}

.scanner-input-wrap{display:flex;gap:12px;margin-bottom:24px}
.scanner-input-wrap input{flex:1;font-size:18px;padding:16px 20px;font-family:SFMono-Regular,Menlo,monospace;letter-spacing:1px}
.scanner-input-wrap button{padding:16px 32px;font-size:15px}
.scan-result{padding:20px;border-radius:var(--radius);margin-bottom:20px;display:none}
.scan-result.valid{background:rgba(52,199,89,0.08);border:1px solid rgba(52,199,89,0.3)}
.scan-result.invalid{background:rgba(255,59,48,0.08);border:1px solid rgba(255,59,48,0.3)}
.scan-result h4{font-size:15px;font-weight:700;margin-bottom:8px}
.scan-result.valid h4{color:var(--success)}
.scan-result.invalid h4{color:var(--error)}
.scan-result .detail-row{display:flex;justify-content:space-between;padding:4px 0;font-size:13px}
.scan-result .detail-row .lbl{color:var(--text2)}
.scan-history-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid var(--border)}
.scan-history-item:last-child{border-bottom:none}
.scan-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.scan-dot.valid{background:var(--success)}
.scan-dot.invalid{background:var(--error)}

.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
.detail-item{padding:10px 14px;background:var(--bg);border-radius:8px}
.detail-item .detail-label{font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px}
.detail-item .detail-value{font-size:14px;font-weight:600;margin-top:2px}
</style>
</head>
<body>

<div id="login-page" class="login-page">
<div class="login-card">
<svg width="40" height="40" viewBox="0 0 24 24" fill="#007AFF" style="margin-bottom:16px"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
<h2>CulturePass</h2>
<p>Dashboard Login</p>
<div class="form-group">
<label>Username</label>
<input type="text" id="login-user" class="form-input" placeholder="admin" value="admin">
</div>
<div class="form-group">
<label>Password</label>
<input type="password" id="login-pass" class="form-input" placeholder="Password">
</div>
<button class="btn btn-primary" style="width:100%;justify-content:center;padding:12px;margin-top:8px" onclick="doLogin()">Sign In</button>
<p id="login-error" style="color:var(--error);font-size:12px;margin-top:12px;display:none"></p>
</div>
</div>

<div id="dashboard" style="display:none">
<div class="sidebar">
<div class="sidebar-logo">
<svg viewBox="0 0 24 24" fill="#007AFF"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
<h1>CulturePass<span>Admin</span></h1>
</div>
<nav class="sidebar-nav">
<div class="nav-section">Overview</div>
<div class="nav-item active" data-page="overview" onclick="switchPage('overview',this)">
<svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
Dashboard
</div>
<div class="nav-section">Management</div>
<div class="nav-item" data-page="tickets" onclick="switchPage('tickets',this)">
<svg viewBox="0 0 24 24" fill="currentColor"><path d="M22 10V6a2 2 0 00-2-2H4c-1.1 0-1.99.9-1.99 2v4c1.1 0 1.99.9 1.99 2s-.89 2-2 2v4c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2v-4c-1.1 0-2-.9-2-2s.9-2 2-2zm-9 5.5h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2v-2h2v2z"/></svg>
Tickets
</div>
<div class="nav-item" data-page="scanner" onclick="switchPage('scanner',this)">
<svg viewBox="0 0 24 24" fill="currentColor"><path d="M9.5 6.5v3h-3v-3h3M11 5H5v6h6V5zm-1.5 9.5v3h-3v-3h3M11 13H5v6h6v-6zm6.5-6.5v3h-3v-3h3M19 5h-6v6h6V5zm-6 8h1.5v1.5H13V13zm1.5 1.5H16V16h-1.5v-1.5zM16 13h1.5v1.5H16V13zm-3 3h1.5v1.5H13V16zm1.5 1.5H16V19h-1.5v-1.5zM16 16h1.5v1.5H16V16zm1.5-1.5H19V16h-1.5v-1.5zm0 3H19V19h-1.5v-1.5z"/></svg>
Scanner
</div>
<div class="nav-item" data-page="events" onclick="switchPage('events',this)">
<svg viewBox="0 0 24 24" fill="currentColor"><path d="M17 12h-5v5h5v-5zM16 1v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19a2 2 0 002 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-1V1h-2zm3 18H5V8h14v11z"/></svg>
Events
</div>
<div class="nav-item" data-page="users" onclick="switchPage('users',this)">
<svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
Users
</div>
<div class="nav-item" data-page="perks" onclick="switchPage('perks',this)">
<svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 6h-2.18c.11-.31.18-.65.18-1a2.996 2.996 0 00-5.5-1.65l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.1.89 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 11 8.76l1-1.36 1 1.36L15.38 12 17 10.83 14.92 8H20v6z"/></svg>
Perks
</div>
<div class="nav-item" data-page="indigenous" onclick="switchPage('indigenous',this)">
<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.22.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
Indigenous
</div>
<div class="nav-section">Analytics</div>
<div class="nav-item" data-page="analytics" onclick="switchPage('analytics',this)">
<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
Analytics
</div>
<div class="nav-item" data-page="revenue" onclick="switchPage('revenue',this)">
<svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>
Revenue
</div>
</nav>
<div style="padding:16px;border-top:1px solid var(--border)">
<div class="nav-item" onclick="doLogout()">
<svg viewBox="0 0 24 24" fill="currentColor"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
Sign Out
</div>
</div>
</div>

<div class="main">
<!-- Overview Page -->
<div id="page-overview" class="page-content">
<div class="topbar">
<h2>Dashboard</h2>
<div class="topbar-actions">
<button class="btn btn-outline" onclick="backfillQR()">
<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M9.5 6.5v3h-3v-3h3M11 5H5v6h6V5zm-1.5 9.5v3h-3v-3h3M11 13H5v6h6v-6zm6.5-6.5v3h-3v-3h3M19 5h-6v6h6V5z"/></svg>
Backfill QR Codes
</button>
<button class="btn btn-primary" onclick="refreshData()">
<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
Refresh
</button>
</div>
</div>

<div class="stats-grid" id="stats-grid"></div>

<div class="grid-2">
<div class="card">
<div class="card-header"><h3>Recent Tickets</h3><a href="#" onclick="switchPage('tickets',document.querySelector('[data-page=tickets]'));return false" style="font-size:13px;font-weight:600">View All</a></div>
<div class="card-body no-pad"><table><thead><tr><th>Event</th><th>Code</th><th>Status</th><th>Amount</th></tr></thead><tbody id="recent-tickets"></tbody></table></div>
</div>
<div class="card">
<div class="card-header"><h3>Revenue by Event</h3></div>
<div class="card-body">
<div class="chart-bar" id="revenue-chart"></div>
<div class="chart-labels" id="revenue-labels"></div>
</div>
</div>
</div>

<div class="card">
<div class="card-header"><h3>Active Perks</h3><a href="#" onclick="switchPage('perks',document.querySelector('[data-page=perks]'));return false" style="font-size:13px;font-weight:600">View All</a></div>
<div class="card-body no-pad"><table><thead><tr><th>Title</th><th>Type</th><th>Provider</th><th>Redemptions</th><th>Status</th></tr></thead><tbody id="perks-table"></tbody></table></div>
</div>
</div>

<!-- Tickets Page -->
<div id="page-tickets" class="page-content" style="display:none">
<div class="topbar">
<h2>Tickets</h2>
<div class="topbar-actions">
<input type="text" class="search-input" placeholder="Search tickets..." id="ticket-search" oninput="filterTickets()">
<select class="form-input" style="width:140px;padding:8px 12px;font-size:13px" id="ticket-filter" onchange="filterTickets()">
<option value="all">All Status</option>
<option value="confirmed">Confirmed</option>
<option value="used">Scanned</option>
<option value="cancelled">Cancelled</option>
</select>
</div>
</div>
<div style="display:flex;gap:12px;margin-bottom:20px">
<div class="stat-card" style="flex:1"><div class="label">Total</div><div class="value" id="ticket-count-total">0</div></div>
<div class="stat-card" style="flex:1"><div class="label">Confirmed</div><div class="value" style="color:var(--success)" id="ticket-count-confirmed">0</div></div>
<div class="stat-card" style="flex:1"><div class="label">Scanned</div><div class="value" style="color:var(--primary)" id="ticket-count-scanned">0</div></div>
<div class="stat-card" style="flex:1"><div class="label">Cancelled</div><div class="value" style="color:var(--error)" id="ticket-count-cancelled">0</div></div>
</div>
<div class="card">
<div class="card-body no-pad">
<table><thead><tr><th>Event</th><th>Ticket Code</th><th>Tier</th><th>Qty</th><th>Amount</th><th>Date</th><th>Status</th><th>Scanned</th><th>Actions</th></tr></thead>
<tbody id="tickets-table"></tbody></table>
</div>
</div>
</div>

<!-- Scanner Page -->
<div id="page-scanner" class="page-content" style="display:none">
<div class="topbar">
<h2>Ticket Scanner</h2>
</div>
<div class="card">
<div class="card-header"><h3>Scan Ticket</h3></div>
<div class="card-body">
<div class="scanner-input-wrap">
<input type="text" id="scan-input" class="form-input" placeholder="Enter ticket code (e.g. TIX-XXXX-XXXX)" onkeydown="if(event.key==='Enter')scanTicket()">
<button class="btn btn-primary" onclick="scanTicket()" style="white-space:nowrap">
<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M9.5 6.5v3h-3v-3h3M11 5H5v6h6V5zm-1.5 9.5v3h-3v-3h3M11 13H5v6h6v-6zm6.5-6.5v3h-3v-3h3M19 5h-6v6h6V5z"/></svg>
Scan Ticket
</button>
</div>
<div id="scan-result" class="scan-result"></div>
</div>
</div>
<div class="card">
<div class="card-header"><h3>Recent Scans</h3><span class="badge badge-info" id="scan-count">0 scans</span></div>
<div class="card-body no-pad" id="scan-history">
<div class="empty-state" style="padding:30px">
<p>No scans yet this session</p>
</div>
</div>
</div>
</div>

<!-- Events Page -->
<div id="page-events" class="page-content" style="display:none">
<div class="topbar">
<h2>Events Overview</h2>
</div>
<div class="stats-grid" id="event-stats"></div>
<div class="card">
<div class="card-header"><h3>All Events</h3></div>
<div class="card-body no-pad">
<table><thead><tr><th>Title</th><th>Date</th><th>Venue</th><th>Category</th><th>Price</th><th>Attending</th><th>Capacity</th></tr></thead>
<tbody id="events-table"></tbody></table>
</div>
</div>
</div>

<!-- Users Page -->
<div id="page-users" class="page-content" style="display:none">
<div class="topbar"><h2>Users</h2></div>
<div class="card">
<div class="card-body no-pad">
<table><thead><tr><th>User</th><th>Email</th><th>Location</th><th>Role</th><th>Verified</th><th>Joined</th></tr></thead>
<tbody id="users-table"></tbody></table>
</div>
</div>
</div>

<!-- Perks Page -->
<div id="page-perks" class="page-content" style="display:none">
<div class="topbar"><h2>Perks & Benefits</h2></div>
<div class="card">
<div class="card-body no-pad">
<table><thead><tr><th>Title</th><th>Type</th><th>Provider</th><th>Discount</th><th>Used / Limit</th><th>Category</th><th>Status</th></tr></thead>
<tbody id="perks-full-table"></tbody></table>
</div>
</div>
</div>

<!-- Analytics Page -->
<div id="page-analytics" class="page-content" style="display:none">
<div class="topbar"><h2>Analytics</h2></div>
<div class="stats-grid" id="analytics-stats"></div>
<div class="grid-2">
<div class="card">
<div class="card-header"><h3>Tickets by Status</h3></div>
<div class="card-body" id="ticket-status-chart"></div>
</div>
<div class="card">
<div class="card-header"><h3>Top Events by Attendance</h3></div>
<div class="card-body no-pad">
<table><thead><tr><th>Event</th><th>Tickets Sold</th><th>Revenue</th></tr></thead>
<tbody id="top-events-table"></tbody></table>
</div>
</div>
</div>
</div>

<!-- Indigenous Visibility Page -->
<div id="page-indigenous" class="page-content" style="display:none">
<div class="topbar"><h2>Indigenous Visibility</h2></div>
<div class="stats-grid">
<div class="stat-card">
<div class="icon" style="background:rgba(139,69,19,0.12)">
<svg width="18" height="18" viewBox="0 0 24 24" fill="#8B4513"><path d="M17 12h-5v5h5v-5zM16 1v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19a2 2 0 002 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-1V1h-2zm3 18H5V8h14v11z"/></svg>
</div>
<div class="label">Indigenous Events</div>
<div class="value" style="color:#8B4513">6</div>
<div class="change up">Across Australia &amp; NZ</div>
</div>
<div class="stat-card">
<div class="icon" style="background:rgba(26,82,118,0.12)">
<svg width="18" height="18" viewBox="0 0 24 24" fill="#1A5276"><path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z"/></svg>
</div>
<div class="label">Indigenous Businesses</div>
<div class="value" style="color:#1A5276">3</div>
<div class="change up">Supply Nation Registered</div>
</div>
<div class="stat-card">
<div class="icon" style="background:rgba(46,134,193,0.12)">
<svg width="18" height="18" viewBox="0 0 24 24" fill="#2E86C1"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
</div>
<div class="label">Indigenous Communities</div>
<div class="value" style="color:#2E86C1">2</div>
<div class="change up">Active &amp; growing</div>
</div>
<div class="stat-card">
<div class="icon" style="background:rgba(52,199,89,0.12)">
<svg width="18" height="18" viewBox="0 0 24 24" fill="#34C759"><path d="M20 6h-2.18c.11-.31.18-.65.18-1a2.996 2.996 0 00-5.5-1.65l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.1.89 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.11-.89-2-2-2z"/></svg>
</div>
<div class="label">Indigenous Perks</div>
<div class="value" id="indigenous-perks-count" style="color:#34C759">3</div>
<div class="change up">Supporting First Nations</div>
</div>
</div>
<div class="grid-2">
<div class="card">
<div class="card-header"><h3>Traditional Custodian Coverage</h3></div>
<div class="card-body">
<div style="display:flex;flex-direction:column;gap:12px">
<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:rgba(139,69,19,0.06);border-radius:8px;border-left:3px solid #8B4513">
<div><strong style="font-size:13px">Sydney</strong><div style="font-size:11px;color:var(--text2)">Gadigal of the Eora Nation</div></div>
<span class="badge badge-success">Active</span>
</div>
<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:rgba(139,69,19,0.06);border-radius:8px;border-left:3px solid #8B4513">
<div><strong style="font-size:13px">Melbourne</strong><div style="font-size:11px;color:var(--text2)">Wurundjeri Woi-wurrung</div></div>
<span class="badge badge-success">Active</span>
</div>
<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:rgba(139,69,19,0.06);border-radius:8px;border-left:3px solid #8B4513">
<div><strong style="font-size:13px">Brisbane</strong><div style="font-size:11px;color:var(--text2)">Turrbal and Jagera/Yuggera</div></div>
<span class="badge badge-success">Active</span>
</div>
<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:rgba(26,82,118,0.06);border-radius:8px;border-left:3px solid #1A5276">
<div><strong style="font-size:13px">Auckland</strong><div style="font-size:11px;color:var(--text2)">Ng&#257;ti Wh&#257;tua &#332;r&#257;kei</div></div>
<span class="badge badge-success">Active</span>
</div>
<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:rgba(26,82,118,0.06);border-radius:8px;border-left:3px solid #1A5276">
<div><strong style="font-size:13px">Wellington</strong><div style="font-size:11px;color:var(--text2)">Te Atiawa, Taranaki Wh&#257;nui</div></div>
<span class="badge badge-success">Active</span>
</div>
<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:rgba(46,134,193,0.06);border-radius:8px;border-left:3px solid #2E86C1">
<div><strong style="font-size:13px">Toronto</strong><div style="font-size:11px;color:var(--text2)">Mississaugas of the Credit</div></div>
<span class="badge badge-success">Active</span>
</div>
<div style="display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:rgba(46,134,193,0.06);border-radius:8px;border-left:3px solid #2E86C1">
<div><strong style="font-size:13px">Vancouver</strong><div style="font-size:11px;color:var(--text2)">Musqueam, Squamish, Tsleil-Waututh</div></div>
<span class="badge badge-success">Active</span>
</div>
</div>
</div>
</div>
<div class="card">
<div class="card-header"><h3>Indigenous Events &amp; Activities</h3></div>
<div class="card-body no-pad">
<table><thead><tr><th>Event</th><th>Type</th><th>Location</th><th>Tags</th></tr></thead>
<tbody>
<tr><td>NAIDOC Week Celebration</td><td><span class="badge badge-info">Cultural</span></td><td>Sydney</td><td><span class="badge" style="background:rgba(139,69,19,0.12);color:#8B4513">NAIDOC Week</span></td></tr>
<tr><td>Dreamtime Stories Evening</td><td><span class="badge badge-info">Storytelling</span></td><td>Melbourne</td><td><span class="badge" style="background:rgba(139,69,19,0.12);color:#8B4513">Cultural Ceremony</span></td></tr>
<tr><td>First Nations Art Exhibition</td><td><span class="badge badge-info">Art</span></td><td>Brisbane</td><td><span class="badge" style="background:rgba(139,69,19,0.12);color:#8B4513">Indigenous-led</span></td></tr>
<tr><td>Indigenous Language Workshop</td><td><span class="badge badge-info">Education</span></td><td>Sydney</td><td><span class="badge" style="background:rgba(139,69,19,0.12);color:#8B4513">First Nations Owned</span></td></tr>
<tr><td>Reconciliation Week Concert</td><td><span class="badge badge-info">Music</span></td><td>Melbourne</td><td><span class="badge" style="background:rgba(139,69,19,0.12);color:#8B4513">Reconciliation Week</span></td></tr>
<tr><td>Aboriginal Bush Food Tour</td><td><span class="badge badge-info">Tour</span></td><td>Sydney</td><td><span class="badge" style="background:rgba(139,69,19,0.12);color:#8B4513">Cultural Ceremony</span></td></tr>
</tbody></table>
</div>
</div>
</div>
<div class="card" style="margin-top:4px">
<div class="card-header"><h3>Acknowledgement of Country</h3></div>
<div class="card-body">
<div style="background:rgba(139,69,19,0.06);border-radius:12px;padding:20px;border-left:4px solid #8B4513">
<p style="font-size:14px;line-height:1.7;color:var(--text)">CulturePass acknowledges the Traditional Custodians of the lands on which events are held across Australia, and we pay our respects to Elders past, present, and emerging. We recognise the continuing connection of Aboriginal and Torres Strait Islander peoples to land, waters, and community.</p>
<p style="font-size:12px;color:var(--text2);margin-top:12px">This acknowledgement is displayed to all users in the onboarding flow and on the home screen when browsing Australian content.</p>
</div>
</div>
</div>
</div>

<!-- Revenue Page -->
<div id="page-revenue" class="page-content" style="display:none">
<div class="topbar"><h2>Revenue Dashboard</h2>
<div class="topbar-actions">
<button class="btn btn-primary" onclick="loadRevenuePage()">
<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
Refresh
</button>
</div>
</div>
<div class="stats-grid" id="revenue-stats"></div>
<div class="card">
<div class="card-header"><h3>Revenue by Event</h3></div>
<div class="card-body no-pad">
<table><thead><tr><th>Event</th><th>Tickets Sold</th><th>Total Revenue</th><th>Platform Fee (5%)</th><th>Organizer Amount</th><th>Scanned</th></tr></thead>
<tbody id="revenue-event-table"></tbody></table>
</div>
</div>
</div>

</div>
</div>

<div class="toast" id="toast"></div>

<div class="modal-overlay" id="ticket-modal">
<div class="modal">
<div class="modal-header"><h3>Ticket Details</h3><button class="modal-close" onclick="closeModal('ticket-modal')">&times;</button></div>
<div class="modal-body" id="ticket-modal-body"></div>
</div>
</div>

<script>
const API = '';
let allTickets = [];
let allUsers = [];
let allPerks = [];
let dashStats = null;
let scanHistory = [];

async function api(path) {
  const r = await fetch(API + path);
  if (!r.ok) throw new Error('API error: ' + r.status);
  return r.json();
}

async function apiPost(path, body) {
  const r = await fetch(API + path, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  return r.json().then(data => { if (!r.ok) { data._httpStatus = r.status; } return data; });
}

async function apiPut(path) {
  const r = await fetch(API + path, {method:'PUT'});
  if (!r.ok) throw new Error('API error: ' + r.status);
  return r.json();
}

function doLogin() {
  const user = document.getElementById('login-user').value;
  const pass = document.getElementById('login-pass').value;
  if (user === 'admin' && pass) {
    fetch(API + '/api/dashboard/login', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({username: user, password: pass})
    }).then(r => r.json()).then(data => {
      if (data.success) {
        sessionStorage.setItem('dash_auth', '1');
        document.getElementById('login-page').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        loadDashboard();
      } else {
        const el = document.getElementById('login-error');
        el.textContent = data.error || 'Invalid credentials';
        el.style.display = 'block';
      }
    }).catch(() => {
      const el = document.getElementById('login-error');
      el.textContent = 'Connection error. Please try again.';
      el.style.display = 'block';
    });
  } else {
    const el = document.getElementById('login-error');
    el.textContent = 'Please enter username and password';
    el.style.display = 'block';
  }
}

function doLogout() {
  sessionStorage.removeItem('dash_auth');
  document.getElementById('dashboard').style.display = 'none';
  document.getElementById('login-page').style.display = '';
  document.getElementById('login-pass').value = '';
}

function switchPage(page, el) {
  document.querySelectorAll('.page-content').forEach(p => p.style.display = 'none');
  document.getElementById('page-' + page).style.display = 'block';
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  if (el) el.classList.add('active');
  if (page === 'revenue') loadRevenuePage();
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

function closeModal(id) {
  document.getElementById(id).classList.remove('show');
}

function statusBadge(status) {
  const map = {confirmed:'success',active:'success',used:'neutral',cancelled:'error',expired:'warning',pending:'warning',inactive:'neutral'};
  const label = status === 'used' ? 'Scanned' : (status || 'unknown');
  return '<span class="badge badge-' + (map[status]||'neutral') + '">' + label + '</span>';
}

function formatDate(d) {
  if (!d) return '-';
  try { return new Date(d).toLocaleDateString('en-AU',{day:'numeric',month:'short',year:'numeric'}); } catch { return d; }
}

function formatDateTime(d) {
  if (!d) return '-';
  try { return new Date(d).toLocaleString('en-AU',{day:'numeric',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}); } catch { return d; }
}

function formatMoney(v) {
  return '$' + (Number(v)||0).toFixed(2);
}

async function loadDashboard() {
  try {
    const [users, perks, tickets, stats] = await Promise.all([
      api('/api/users'),
      api('/api/perks'),
      api('/api/tickets-all'),
      api('/api/dashboard/stats')
    ]);
    allUsers = users;
    allPerks = perks;
    allTickets = tickets;
    dashStats = stats;
    renderOverview();
    renderTicketsPage();
    renderEventsPage();
    renderUsersPage();
    renderPerksPage();
    renderAnalytics();
  } catch(e) { console.error('Dashboard load error:', e); }
}

async function refreshData() {
  showToast('Refreshing data...');
  await loadDashboard();
  showToast('Data refreshed');
}

async function backfillQR() {
  try {
    const result = await apiPost('/api/tickets/backfill-qr', {});
    showToast(result.message || 'QR codes backfilled');
    await refreshData();
  } catch(e) {
    showToast('Error backfilling QR codes');
  }
}

function renderOverview() {
  const s = dashStats || {};
  document.getElementById('stats-grid').innerHTML =
    '<div class="stat-card"><div class="icon" style="background:rgba(0,122,255,0.12)"><svg width="18" height="18" viewBox="0 0 24 24" fill="#007AFF"><path d="M22 10V6a2 2 0 00-2-2H4c-1.1 0-2 .9-2 2v4c1.1 0 2 .9 2 2s-.9 2-2 2v4c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2v-4c-1.1 0-2-.9-2-2s.9-2 2-2z"/></svg></div><div class="label">Total Tickets</div><div class="value">' + (s.totalTickets||allTickets.length) + '</div><div class="change up">' + (s.confirmedTickets||0) + ' confirmed</div></div>' +
    '<div class="stat-card"><div class="icon" style="background:rgba(52,199,89,0.12)"><svg width="18" height="18" viewBox="0 0 24 24" fill="#34C759"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></div><div class="label">Scanned / Attended</div><div class="value">' + (s.scannedTickets||0) + '</div><div class="change up">' + (s.totalTickets ? Math.round((s.scannedTickets||0)/(s.totalTickets)*100) : 0) + '% attendance</div></div>' +
    '<div class="stat-card"><div class="icon" style="background:rgba(52,199,89,0.12)"><svg width="18" height="18" viewBox="0 0 24 24" fill="#34C759"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-2.22-1.87-1.5 0-2.4.68-2.4 1.64 0 .84.65 1.39 2.67 1.94s4.18 1.36 4.18 3.85c0 1.89-1.44 2.93-3.12 3.19z"/></svg></div><div class="label">Total Revenue</div><div class="value">' + formatMoney(s.totalRevenue||0) + '</div></div>' +
    '<div class="stat-card"><div class="icon" style="background:rgba(88,86,214,0.12)"><svg width="18" height="18" viewBox="0 0 24 24" fill="#5856D6"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg></div><div class="label">Platform Revenue (5%)</div><div class="value">' + formatMoney(s.platformRevenue||0) + '</div></div>';

  const tbody = document.getElementById('recent-tickets');
  tbody.innerHTML = allTickets.slice(0, 5).map(t =>
    '<tr style="cursor:pointer" onclick="showTicketDetail(\'' + t.id + '\')">' +
      '<td><strong>' + (t.eventTitle||'-') + '</strong></td>' +
      '<td><span class="ticket-code">' + (t.ticketCode||'-') + '</span></td>' +
      '<td>' + statusBadge(t.status) + '</td>' +
      '<td>' + formatMoney(t.totalPrice) + '</td>' +
    '</tr>'
  ).join('') || '<tr><td colspan="4" style="text-align:center;color:var(--text2);padding:20px">No tickets yet</td></tr>';

  const breakdown = (s.eventBreakdown || []).slice(0, 7);
  if (breakdown.length > 0) {
    const maxVal = Math.max(...breakdown.map(e => e.revenue), 1);
    document.getElementById('revenue-chart').innerHTML = breakdown.map(e =>
      '<div class="bar" style="height:' + ((e.revenue/maxVal)*100) + '%" title="' + e.eventTitle + ': ' + formatMoney(e.revenue) + '"></div>'
    ).join('');
    document.getElementById('revenue-labels').innerHTML = breakdown.map(e =>
      '<span>' + (e.eventTitle||'').substring(0,8) + '</span>'
    ).join('');
  } else {
    document.getElementById('revenue-chart').innerHTML = '<div style="text-align:center;color:var(--text3);padding:40px 0;width:100%">No revenue data</div>';
    document.getElementById('revenue-labels').innerHTML = '';
  }
}

function renderTicketsPage() {
  const confirmed = allTickets.filter(t => t.status === 'confirmed').length;
  const scanned = allTickets.filter(t => t.status === 'used').length;
  const cancelled = allTickets.filter(t => t.status === 'cancelled').length;
  document.getElementById('ticket-count-total').textContent = allTickets.length;
  document.getElementById('ticket-count-confirmed').textContent = confirmed;
  document.getElementById('ticket-count-scanned').textContent = scanned;
  document.getElementById('ticket-count-cancelled').textContent = cancelled;
  filterTickets();
}

function filterTickets() {
  const search = (document.getElementById('ticket-search').value || '').toLowerCase();
  const filter = document.getElementById('ticket-filter').value;
  const filtered = allTickets.filter(t => {
    if (filter !== 'all' && t.status !== filter) return false;
    if (search && !(t.eventTitle||'').toLowerCase().includes(search) && !(t.ticketCode||'').toLowerCase().includes(search)) return false;
    return true;
  });
  document.getElementById('tickets-table').innerHTML = filtered.map(t =>
    '<tr>' +
      '<td><strong>' + (t.eventTitle||'-') + '</strong></td>' +
      '<td><span class="ticket-code">' + (t.ticketCode||'-') + '</span></td>' +
      '<td>' + (t.tierName||'General') + '</td>' +
      '<td>' + (t.quantity||1) + '</td>' +
      '<td>' + formatMoney(t.totalPrice) + '</td>' +
      '<td>' + formatDate(t.eventDate) + '</td>' +
      '<td>' + statusBadge(t.status) + '</td>' +
      '<td>' + (t.scannedAt ? '<span class="badge badge-info">' + formatDateTime(t.scannedAt) + '</span>' : '<span style="color:var(--text3)">-</span>') + '</td>' +
      '<td>' +
        '<button class="btn btn-sm btn-outline" onclick="showTicketDetail(\'' + t.id + '\')">View</button> ' +
        (t.status === 'confirmed' ? '<button class="btn btn-sm btn-success" onclick="scanTicketById(\'' + t.ticketCode + '\')">Scan</button> ' : '') +
        (t.status === 'confirmed' ? '<button class="btn btn-sm btn-danger" onclick="cancelTicket(\'' + t.id + '\')">Cancel</button>' : '') +
      '</td>' +
    '</tr>'
  ).join('') || '<tr><td colspan="9" style="text-align:center;color:var(--text2);padding:20px">No tickets found</td></tr>';
}

async function cancelTicket(id) {
  if (!confirm('Cancel this ticket?')) return;
  try {
    await apiPut('/api/tickets/' + id + '/cancel');
    showToast('Ticket cancelled');
    await refreshData();
  } catch(e) { showToast('Error cancelling ticket'); }
}

async function scanTicketById(code) {
  if (!code) return;
  try {
    const result = await apiPost('/api/tickets/scan', { ticketCode: code, scannedBy: 'admin' });
    if (result.valid) {
      showToast('Ticket scanned successfully');
      addScanHistory(code, true, result.ticket);
      await refreshData();
    } else {
      showToast(result.error || 'Scan failed');
      addScanHistory(code, false, result.ticket, result.error);
    }
  } catch(e) { showToast('Error scanning ticket'); }
}

function showTicketDetail(id) {
  const t = allTickets.find(x => x.id === id);
  if (!t) return;
  const platformFee = (Number(t.platformFee) || (Number(t.totalPrice)||0) * 0.05);
  const stripeFee = (Number(t.totalPrice)||0) * 0.029 + 0.30;
  const organizerAmount = (Number(t.organizerAmount) || (Number(t.totalPrice)||0) - platformFee);

  let html = '<div class="detail-grid">' +
    '<div class="detail-item"><div class="detail-label">Event</div><div class="detail-value">' + (t.eventTitle||'-') + '</div></div>' +
    '<div class="detail-item"><div class="detail-label">Ticket Code</div><div class="detail-value"><span class="ticket-code">' + (t.ticketCode||'-') + '</span></div></div>' +
    '<div class="detail-item"><div class="detail-label">Tier</div><div class="detail-value">' + (t.tierName||'General') + '</div></div>' +
    '<div class="detail-item"><div class="detail-label">Quantity</div><div class="detail-value">' + (t.quantity||1) + '</div></div>' +
    '<div class="detail-item"><div class="detail-label">Venue</div><div class="detail-value">' + (t.eventVenue||'-') + '</div></div>' +
    '<div class="detail-item"><div class="detail-label">Date</div><div class="detail-value">' + formatDate(t.eventDate) + '</div></div>' +
    '<div class="detail-item"><div class="detail-label">Status</div><div class="detail-value">' + statusBadge(t.status) + '</div></div>' +
    '<div class="detail-item"><div class="detail-label">Buyer</div><div class="detail-value">' + (t.buyerName||t.userId||'-') + '</div></div>' +
  '</div>';

  if (t.qrCode) {
    html += '<div style="text-align:center;margin-bottom:16px;padding:16px;background:var(--bg);border-radius:8px">' +
      '<img src="' + t.qrCode + '" alt="QR Code" style="width:160px;height:160px;image-rendering:pixelated">' +
      '<div style="font-size:11px;color:var(--text2);margin-top:8px">Scan QR code for entry</div>' +
    '</div>';
  }

  if (t.status === 'used' || t.scannedAt) {
    html += '<div style="padding:12px 16px;background:rgba(52,199,89,0.08);border:1px solid rgba(52,199,89,0.2);border-radius:8px;margin-bottom:16px">' +
      '<div style="font-size:12px;font-weight:600;color:var(--success);text-transform:uppercase;margin-bottom:4px">Scanned</div>' +
      '<div style="font-size:13px">Scanned at: <strong>' + formatDateTime(t.scannedAt) + '</strong></div>' +
      '<div style="font-size:13px">Scanned by: <strong>' + (t.scannedBy||'staff') + '</strong></div>' +
    '</div>';
  }

  html += '<div style="margin-top:16px"><h4 style="font-size:14px;font-weight:700;margin-bottom:12px">Payment Breakdown</h4>' +
    '<div class="detail-grid">' +
      '<div class="detail-item"><div class="detail-label">Total Price</div><div class="detail-value">' + formatMoney(t.totalPrice) + '</div></div>' +
      '<div class="detail-item"><div class="detail-label">Platform Fee (5%)</div><div class="detail-value">' + formatMoney(platformFee) + '</div></div>' +
      '<div class="detail-item"><div class="detail-label">Stripe Fee (~2.9%+30c)</div><div class="detail-value">' + formatMoney(stripeFee) + '</div></div>' +
      '<div class="detail-item"><div class="detail-label">Organizer Amount</div><div class="detail-value">' + formatMoney(organizerAmount) + '</div></div>' +
    '</div></div>';

  document.getElementById('ticket-modal-body').innerHTML = html;
  document.getElementById('ticket-modal').classList.add('show');
}

async function scanTicket() {
  const input = document.getElementById('scan-input');
  const code = input.value.trim();
  if (!code) { showToast('Please enter a ticket code'); return; }

  const resultEl = document.getElementById('scan-result');
  resultEl.style.display = 'none';

  try {
    const result = await apiPost('/api/tickets/scan', { ticketCode: code, scannedBy: 'admin' });

    if (result.valid) {
      const t = result.ticket || {};
      resultEl.className = 'scan-result valid';
      resultEl.innerHTML = '<h4>&#10003; Valid Ticket - Scanned Successfully</h4>' +
        '<div class="detail-row"><span class="lbl">Event</span><span>' + (t.eventTitle||'-') + '</span></div>' +
        '<div class="detail-row"><span class="lbl">Tier</span><span>' + (t.tierName||'General') + '</span></div>' +
        '<div class="detail-row"><span class="lbl">Quantity</span><span>' + (t.quantity||1) + '</span></div>' +
        '<div class="detail-row"><span class="lbl">Venue</span><span>' + (t.eventVenue||'-') + '</span></div>' +
        '<div class="detail-row"><span class="lbl">Code</span><span class="ticket-code">' + (t.ticketCode||code) + '</span></div>';
      resultEl.style.display = 'block';
      addScanHistory(code, true, t);
      showToast('Ticket scanned successfully');
      input.value = '';
      input.focus();
      refreshData();
    } else {
      resultEl.className = 'scan-result invalid';
      resultEl.innerHTML = '<h4>&#10007; ' + (result.error||'Invalid Ticket') + '</h4>';
      if (result.ticket) {
        const t = result.ticket;
        resultEl.innerHTML += '<div class="detail-row"><span class="lbl">Event</span><span>' + (t.eventTitle||'-') + '</span></div>' +
          '<div class="detail-row"><span class="lbl">Status</span><span>' + statusBadge(t.status) + '</span></div>';
        if (result.scannedAt) {
          resultEl.innerHTML += '<div class="detail-row"><span class="lbl">Previously Scanned</span><span>' + formatDateTime(result.scannedAt) + '</span></div>';
        }
      }
      resultEl.style.display = 'block';
      addScanHistory(code, false, result.ticket, result.error);
    }
  } catch(e) {
    resultEl.className = 'scan-result invalid';
    resultEl.innerHTML = '<h4>&#10007; Error scanning ticket</h4><p style="font-size:13px;color:var(--text2)">' + e.message + '</p>';
    resultEl.style.display = 'block';
    addScanHistory(code, false, null, e.message);
  }
}

function addScanHistory(code, valid, ticket, error) {
  scanHistory.unshift({ code, valid, ticket, error, time: new Date() });
  renderScanHistory();
}

function renderScanHistory() {
  document.getElementById('scan-count').textContent = scanHistory.length + ' scans';
  if (scanHistory.length === 0) {
    document.getElementById('scan-history').innerHTML = '<div class="empty-state" style="padding:30px"><p>No scans yet this session</p></div>';
    return;
  }
  document.getElementById('scan-history').innerHTML = scanHistory.map(s =>
    '<div class="scan-history-item">' +
      '<div class="scan-dot ' + (s.valid ? 'valid' : 'invalid') + '"></div>' +
      '<div style="flex:1;min-width:0">' +
        '<div style="font-size:13px;font-weight:600">' + (s.valid ? (s.ticket?.eventTitle||s.code) : (s.error||'Invalid')) + '</div>' +
        '<div style="font-size:12px;color:var(--text2)">' + s.code + '</div>' +
      '</div>' +
      '<span class="badge ' + (s.valid ? 'badge-success' : 'badge-error') + '">' + (s.valid ? 'Valid' : 'Failed') + '</span>' +
      '<span style="font-size:11px;color:var(--text3);min-width:50px;text-align:right">' + s.time.toLocaleTimeString('en-AU',{hour:'2-digit',minute:'2-digit'}) + '</span>' +
    '</div>'
  ).join('');
}

function renderEventsPage() {
  const events = {};
  allTickets.forEach(t => {
    if (!events[t.eventId]) events[t.eventId] = { title: t.eventTitle, date: t.eventDate, venue: t.eventVenue, category: t.eventCategory||'-', price: t.tierPrice||t.totalPrice, attending: 0, capacity: t.eventCapacity||'-' };
    events[t.eventId].attending += (t.quantity || 1);
  });
  const evList = Object.values(events);

  document.getElementById('event-stats').innerHTML =
    '<div class="stat-card"><div class="label">Total Events</div><div class="value">' + evList.length + '</div></div>' +
    '<div class="stat-card"><div class="label">Total Attendees</div><div class="value">' + evList.reduce((s,e)=>s+e.attending,0) + '</div></div>' +
    '<div class="stat-card"><div class="label">Avg Attendance</div><div class="value">' + (evList.length ? Math.round(evList.reduce((s,e)=>s+e.attending,0)/evList.length) : 0) + '</div></div>' +
    '<div class="stat-card"><div class="label">Revenue</div><div class="value">' + formatMoney(allTickets.reduce((s,t)=>s+(Number(t.totalPrice)||0),0)) + '</div></div>';

  document.getElementById('events-table').innerHTML = evList.map(e =>
    '<tr><td><strong>' + (e.title||'-') + '</strong></td><td>' + formatDate(e.date) + '</td><td>' + (e.venue||'-') + '</td><td>' + e.category + '</td><td>' + formatMoney(e.price) + '</td><td>' + e.attending + '</td><td>' + e.capacity + '</td></tr>'
  ).join('') || '<tr><td colspan="7" style="text-align:center;color:var(--text2);padding:20px">No events</td></tr>';
}

function renderUsersPage() {
  document.getElementById('users-table').innerHTML = allUsers.map(u =>
    '<tr><td><div style="display:flex;align-items:center;gap:10px"><div class="avatar">' + (u.displayName||u.email||'?').charAt(0).toUpperCase() + '</div><div><strong>' + (u.displayName||'-') + '</strong><div style="font-size:12px;color:var(--text2)">@' + (u.username||'-') + '</div></div></div></td>' +
    '<td>' + (u.email||'-') + '</td><td>' + (u.location||'-') + '</td><td>' + statusBadge(u.role||'user') + '</td>' +
    '<td>' + (u.verified ? '<span class="badge badge-success">Verified</span>' : '<span class="badge badge-neutral">No</span>') + '</td>' +
    '<td>' + formatDate(u.createdAt) + '</td></tr>'
  ).join('') || '<tr><td colspan="6" style="text-align:center;color:var(--text2);padding:20px">No users</td></tr>';
}

function renderPerksPage() {
  const renderPerkRow = (p, full) =>
    '<tr><td><strong>' + (p.title||'-') + '</strong></td><td><span class="badge badge-info">' + (p.type||'-') + '</span></td><td>' + (p.provider||'-') + '</td>' +
    (full ? '<td>' + (p.discount||'-') + '</td><td>' + (p.redemptionCount||0) + ' / ' + (p.redemptionLimit||'') + '</td><td>' + (p.category||'-') + '</td>' : '<td>' + (p.redemptionCount||0) + '</td>') +
    '<td>' + statusBadge(p.status) + '</td></tr>';

  document.getElementById('perks-table').innerHTML = allPerks.slice(0,5).map(p => renderPerkRow(p, false)).join('') || '<tr><td colspan="5" style="text-align:center;color:var(--text2);padding:20px">No perks</td></tr>';
  document.getElementById('perks-full-table').innerHTML = allPerks.map(p => renderPerkRow(p, true)).join('') || '<tr><td colspan="7" style="text-align:center;color:var(--text2);padding:20px">No perks</td></tr>';
}

function renderAnalytics() {
  const s = dashStats || {};
  const confirmed = s.confirmedTickets || allTickets.filter(t => t.status === 'confirmed').length;
  const used = s.scannedTickets || allTickets.filter(t => t.status === 'used').length;
  const cancelled = s.cancelledTickets || allTickets.filter(t => t.status === 'cancelled').length;
  const total = s.totalTickets || allTickets.length;
  const revenue = s.totalRevenue || allTickets.reduce((sum,t) => sum + (Number(t.totalPrice)||0), 0);

  document.getElementById('analytics-stats').innerHTML =
    '<div class="stat-card"><div class="label">Total Tickets</div><div class="value">' + total + '</div></div>' +
    '<div class="stat-card"><div class="label">Scanned</div><div class="value">' + used + '</div><div class="change up">' + (total ? Math.round(used/total*100) : 0) + '% rate</div></div>' +
    '<div class="stat-card"><div class="label">Revenue</div><div class="value">' + formatMoney(revenue) + '</div></div>' +
    '<div class="stat-card"><div class="label">Users</div><div class="value">' + (s.totalUsers || allUsers.length) + '</div></div>';

  const maxStatus = Math.max(confirmed, used, cancelled, 1);
  document.getElementById('ticket-status-chart').innerHTML =
    '<div style="display:flex;flex-direction:column;gap:12px">' +
      '<div style="display:flex;align-items:center;gap:12px"><div style="width:80px;font-size:12px;font-weight:600;color:var(--text2)">Confirmed</div><div style="flex:1;height:24px;background:var(--bg);border-radius:6px;overflow:hidden"><div style="width:' + (confirmed/maxStatus*100) + '%;height:100%;background:var(--success);border-radius:6px"></div></div><span style="font-size:13px;font-weight:600;width:40px;text-align:right">' + confirmed + '</span></div>' +
      '<div style="display:flex;align-items:center;gap:12px"><div style="width:80px;font-size:12px;font-weight:600;color:var(--text2)">Scanned</div><div style="flex:1;height:24px;background:var(--bg);border-radius:6px;overflow:hidden"><div style="width:' + (used/maxStatus*100) + '%;height:100%;background:var(--primary);border-radius:6px"></div></div><span style="font-size:13px;font-weight:600;width:40px;text-align:right">' + used + '</span></div>' +
      '<div style="display:flex;align-items:center;gap:12px"><div style="width:80px;font-size:12px;font-weight:600;color:var(--text2)">Cancelled</div><div style="flex:1;height:24px;background:var(--bg);border-radius:6px;overflow:hidden"><div style="width:' + (cancelled/maxStatus*100) + '%;height:100%;background:var(--error);border-radius:6px"></div></div><span style="font-size:13px;font-weight:600;width:40px;text-align:right">' + cancelled + '</span></div>' +
    '</div>';

  const breakdown = (s.eventBreakdown || []).slice(0, 10);
  document.getElementById('top-events-table').innerHTML = breakdown.map(e =>
    '<tr><td><strong>' + (e.eventTitle||'-') + '</strong></td><td>' + e.tickets + '</td><td>' + formatMoney(e.revenue) + '</td></tr>'
  ).join('') || '<tr><td colspan="3" style="text-align:center;color:var(--text2);padding:20px">No data</td></tr>';
}

async function loadRevenuePage() {
  try {
    const stats = await api('/api/dashboard/stats');
    dashStats = stats;
    const s = stats;
    const stripeFees = (s.totalRevenue||0) * 0.029 + (s.totalTickets||0) * 0.30;

    document.getElementById('revenue-stats').innerHTML =
      '<div class="stat-card"><div class="icon" style="background:rgba(52,199,89,0.12)"><svg width="18" height="18" viewBox="0 0 24 24" fill="#34C759"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-2.22-1.87-1.5 0-2.4.68-2.4 1.64 0 .84.65 1.39 2.67 1.94s4.18 1.36 4.18 3.85c0 1.89-1.44 2.93-3.12 3.19z"/></svg></div><div class="label">Total Revenue</div><div class="value">' + formatMoney(s.totalRevenue) + '</div></div>' +
      '<div class="stat-card"><div class="icon" style="background:rgba(0,122,255,0.12)"><svg width="18" height="18" viewBox="0 0 24 24" fill="#007AFF"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg></div><div class="label">Platform Revenue (5%)</div><div class="value">' + formatMoney(s.platformRevenue) + '</div></div>' +
      '<div class="stat-card"><div class="icon" style="background:rgba(255,149,0,0.12)"><svg width="18" height="18" viewBox="0 0 24 24" fill="#FF9500"><path d="M21 18v1c0 1.1-.9 2-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h14c1.1 0 2 .9 2 2v1h-9a2 2 0 00-2 2v8a2 2 0 002 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg></div><div class="label">Organizer Revenue</div><div class="value">' + formatMoney(s.organizerRevenue) + '</div></div>' +
      '<div class="stat-card"><div class="icon" style="background:rgba(88,86,214,0.12)"><svg width="18" height="18" viewBox="0 0 24 24" fill="#5856D6"><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/></svg></div><div class="label">Est. Stripe Fees</div><div class="value">' + formatMoney(stripeFees) + '</div></div>';

    const breakdown = s.eventBreakdown || [];
    document.getElementById('revenue-event-table').innerHTML = breakdown.map(e => {
      const platformFee = e.revenue * 0.05;
      return '<tr><td><strong>' + (e.eventTitle||'-') + '</strong></td><td>' + e.tickets + '</td><td>' + formatMoney(e.revenue) + '</td><td>' + formatMoney(platformFee) + '</td><td>' + formatMoney(e.organizerAmount) + '</td><td>' + e.scanned + '</td></tr>';
    }).join('') || '<tr><td colspan="6" style="text-align:center;color:var(--text2);padding:20px">No revenue data</td></tr>';
  } catch(e) {
    console.error('Revenue load error:', e);
    showToast('Error loading revenue data');
  }
}

if (sessionStorage.getItem('dash_auth') === '1') {
  document.getElementById('login-page').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';
  loadDashboard();
}
</script>
</body>
</html>
